name: Deploy to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'lambda_handler.py'
      - 'src/s3_utils.py'
      - 'deploy_lambda.sh'
      - 'deploy_lambda_with_layer.sh'
      - 'deploy_all.sh'
      - 'setup_s3.sh'
      - 'build_lambda_layer.sh'
      - 'run_aws.py'
      - '.github/workflows/deploy-to-aws.yml'
  workflow_dispatch:
    inputs:
      deploy_lambda:
        description: 'Deploy Lambda function'
        required: false
        default: true
        type: boolean
      upload_model:
        description: 'Upload model to S3'
        required: false
        default: true
        type: boolean

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-2

    - name: Setup S3 bucket
      run: |
        chmod +x setup_s3.sh
        ./setup_s3.sh

    - name: Install dependencies
      if: ${{ github.event.inputs.upload_model == 'true' || github.event_name == 'push' }}
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Train and upload model to S3
      if: ${{ github.event.inputs.upload_model == 'true' || github.event_name == 'push' }}
      env:
        SAVE_TO_S3: 'true'
        AWS_BUCKET_NAME: 'wine-quality-mlops-sujan'
        AWS_REGION: 'us-east-2'
      run: |
        zenml init
        zenml integration install mlflow -y
        python run_aws.py

    - name: Deploy Lambda function with Layer
      if: ${{ github.event.inputs.deploy_lambda == 'true' || github.event_name == 'push' }}
      run: |
        chmod +x deploy_lambda_with_layer.sh
        ./deploy_lambda_with_layer.sh

    - name: Get Lambda endpoint
      id: lambda-url
      run: |
        API_ID=$(aws apigatewayv2 get-apis --region us-east-2 --query "Items[?Name=='wine-quality-predictor-api'].ApiId" --output text)
        API_ENDPOINT=$(aws apigatewayv2 get-apis --region us-east-2 --query "Items[?ApiId=='${API_ID}'].ApiEndpoint" --output text)
        echo "endpoint=${API_ENDPOINT}" >> $GITHUB_OUTPUT
        echo "âœ… Lambda endpoint: ${API_ENDPOINT}"

    - name: Test Lambda endpoint
      run: |
        curl -X POST ${{ steps.lambda-url.outputs.endpoint }} \
          -H 'Content-Type: application/json' \
          -d '{"fixed_acidity":7.4,"volatile_acidity":0.7,"citric_acid":0,"residual_sugar":1.9,"chlorides":0.076,"free_sulfur_dioxide":11,"total_sulfur_dioxide":34,"density":0.9978,"pH":3.51,"sulphates":0.56,"alcohol":9.4,"wine_type_encoded":0}'

    - name: Comment on commit
      uses: actions/github-script@v7
      with:
        script: |
          const endpoint = '${{ steps.lambda-url.outputs.endpoint }}';
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `ğŸš€ **AWS Deployment Successful!**\n\nğŸ”— Lambda Endpoint:\n\`${endpoint}\`\n\nğŸ“ Update your Streamlit dashboard with this URL.`
          })
