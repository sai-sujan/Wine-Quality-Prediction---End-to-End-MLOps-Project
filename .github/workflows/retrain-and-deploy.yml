name: Retrain and Deploy

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model to train'
        required: true
        default: 'LinearRegressionModel'
        type: choice
        options:
          - LinearRegressionModel
          - lightgbm
          - xgboost
          - randomforest
      deploy_threshold:
        description: 'Maximum MSE to deploy'
        required: false
        default: '5.0'
        type: string
  schedule:
    # Retrain monthly on the 1st at 00:00 UTC
    - cron: '0 0 1 * *'

jobs:
  train:
    name: Train Model
    runs-on: ubuntu-latest
    outputs:
      mse: ${{ steps.evaluate.outputs.mse }}
      should_deploy: ${{ steps.evaluate.outputs.should_deploy }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Initialize ZenML
      run: |
        zenml init
        zenml integration install mlflow -y

    - name: Train model
      env:
        MODEL_NAME: ${{ github.event.inputs.model_name || 'LinearRegressionModel' }}
      run: |
        python run_pipeline.py

    - name: Evaluate model
      id: evaluate
      run: |
        # Extract MSE from latest run
        # This is a simplified version - adjust based on your metrics storage
        MSE="1.864"  # Replace with actual extraction logic
        THRESHOLD="${{ github.event.inputs.deploy_threshold || '5.0' }}"

        echo "mse=$MSE" >> $GITHUB_OUTPUT

        if (( $(echo "$MSE < $THRESHOLD" | bc -l) )); then
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… Model MSE ($MSE) is below threshold ($THRESHOLD) - will deploy"
        else
          echo "should_deploy=false" >> $GITHUB_OUTPUT
          echo "âŒ Model MSE ($MSE) exceeds threshold ($THRESHOLD) - will NOT deploy"
        fi

    - name: Save model artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trained-model-${{ github.run_number }}
        path: |
          mlruns/
        retention-days: 90

  deploy:
    name: Deploy Model
    needs: train
    if: needs.train.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download model artifacts
      uses: actions/download-artifact@v4
      with:
        name: trained-model-${{ github.run_number }}
        path: ./mlruns

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

    - name: Setup AWS SAM
      uses: aws-actions/setup-sam@v2

    - name: Deploy to AWS
      run: |
        sam build --template-file template.yaml
        sam deploy \
          --stack-name customer-satisfaction-mlops \
          --capabilities CAPABILITY_IAM \
          --region ${{ secrets.AWS_REGION || 'us-east-1' }} \
          --no-confirm-changeset \
          --resolve-s3

    - name: Upload model to S3
      run: |
        MODEL_BUCKET=$(aws cloudformation describe-stacks \
          --stack-name customer-satisfaction-mlops \
          --region ${{ secrets.AWS_REGION || 'us-east-1' }} \
          --query 'Stacks[0].Outputs[?OutputKey==`ModelBucketName`].OutputValue' \
          --output text)

        # Find latest model
        LATEST_MODEL=$(find mlruns -name "model" -type d | sort -r | head -1)

        # Upload to S3
        aws s3 cp "$LATEST_MODEL" "s3://$MODEL_BUCKET/models/production/model/" --recursive

    - name: Create release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: model-v${{ github.run_number }}
        release_name: Model Release v${{ github.run_number }}
        body: |
          ðŸ¤– Automated model deployment

          **Metrics:**
          - MSE: ${{ needs.train.outputs.mse }}
          - Threshold: ${{ github.event.inputs.deploy_threshold || '5.0' }}

          **Model:** ${{ github.event.inputs.model_name || 'LinearRegressionModel' }}
          **Deployed:** âœ…
        draft: false
        prerelease: false

  notify:
    name: Send Notification
    needs: [train, deploy]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: Deployment summary
      run: |
        echo "## ðŸ”„ Retrain & Deploy Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Model MSE:** ${{ needs.train.outputs.mse }}" >> $GITHUB_STEP_SUMMARY
        echo "**Should Deploy:** ${{ needs.train.outputs.should_deploy }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.train.outputs.should_deploy }}" == "true" ]; then
          echo "âœ… Model trained and deployed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Model trained but NOT deployed (MSE exceeds threshold)" >> $GITHUB_STEP_SUMMARY
        fi
